<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>Command Center</title>

<style>
:root {
  --bg:#0b1020;
  --panel:#11162a;
  --border:#24304f;
  --text:#e6e8ef;
  --muted:#8b93b8;
  --blue:#4f7cff;
  --green:#22c55e;
  --red:#ef4444;
}

* {
  box-sizing:border-box;
  font-family:ui-monospace,Menlo,monospace;
}

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  height:100vh;
}

/* ===== Login ===== */
#login {
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.login-box {
  width:360px;
  padding:28px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
}

.login-box h1 {
  text-align:center;
  margin:0 0 14px;
}

.login-box input {
  width:100%;
  margin-top:12px;
  padding:10px;
  background:transparent;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:6px;
}

.login-box button {
  width:100%;
  margin-top:16px;
  padding:10px;
  background:var(--blue);
  border:none;
  border-radius:6px;
  color:#fff;
  cursor:pointer;
}

/* ===== App ===== */
#app {
  display:none;
  height:100vh;
}

#layout {
  display:grid;
  grid-template-columns:320px 1fr;
  height:100%;
}

/* ===== Sidebar ===== */
#sidebar {
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:12px;
  display:flex;
  flex-direction:column;
}

#sidebar h3 {
  margin:6px 0 8px;
  font-size:13px;
  color:var(--muted);
}

#clients {
  list-style:none;
  padding:0;
  margin:0;
  overflow-y:auto;
  flex:1;
}

.client {
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  margin-bottom:8px;
}

.client-header {
  display:flex;
  align-items:center;
  gap:6px;
}

.client-header span.id {
  flex:1;
  font-size:13px;
  word-break:break-all;
}

.client.online { border-color:#1e3a8a; }
.client.offline { opacity:0.6; }

.client .status {
  font-size:11px;
}

.client .lastseen {
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}

/* ===== Main ===== */
#main {
  display:flex;
  flex-direction:column;
  height:100%;
}

#topbar {
  display:flex;
  gap:8px;
  padding:10px;
  border-bottom:1px solid var(--border);
}

#cmd {
  flex:1;
  padding:10px;
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
}

#run, #clear {
  padding:10px 16px;
  background:var(--blue);
  border:none;
  color:#fff;
  cursor:pointer;
  border-radius:6px;
}

#clear {
  background:#374151;
}

#log {
  flex:1;
  padding:12px;
  overflow-y:auto;
  white-space:pre-wrap;
  font-size:13px;
}

.log-ok { color:var(--green); }
.log-err { color:var(--red); }
.log-info { color:var(--muted); }
</style>
</head>

<body>

<!-- ===== Login ===== -->
<div id="login">
  <div class="login-box">
    <h1>Command Center</h1>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="doLogin()">Login</button>
  </div>
</div>

<!-- ===== App ===== -->
<div id="app">
  <div id="layout">

    <div id="sidebar">
      <h3>Clients</h3>
      <ul id="clients"></ul>
    </div>

    <div id="main">
      <div id="topbar">
        <input id="cmd" placeholder="command">
        <button id="run" onclick="execCmd()">Run</button>
        <button id="clear" onclick="clearLog()">Clear</button>
      </div>

      <div id="log"></div>
    </div>

  </div>
</div>

<script>
/* ===== DOM ===== */
const loginBox  = document.getElementById("login");
const appBox    = document.getElementById("app");
const logBox    = document.getElementById("log");
const clientsUL = document.getElementById("clients");
const cmdInput  = document.getElementById("cmd");

/* ===== State ===== */
let ws;
let reconnectDelay = 1000;

const selected = new Set();
const onlineClients = new Set();
const lastSeenMap = new Map();
const clientRows = new Map();

/* ===== Utils ===== */
function addLog(msg, cls="log-info") {
  const d = document.createElement("div");
  d.className = cls;
  d.textContent = msg;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

function clearLog() {
  logBox.innerHTML = "";
}

function now() {
  return Date.now();
}

function formatAgo(ts) {
  const sec = Math.floor((now() - ts) / 1000);
  if (sec < 60) return sec + "s ago";
  if (sec < 3600) return Math.floor(sec/60) + "m ago";
  return Math.floor(sec/3600) + "h ago";
}

/* ===== Login ===== */
function doLogin() {
  fetch("/api/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user: document.getElementById("user").value,
      pass: document.getElementById("pass").value
    })
  }).then(r=>{
    if(r.ok){
      loginBox.style.display="none";
      appBox.style.display="block";
      connectWS();
    } else {
      alert("login failed");
    }
  });
}

/* ===== WebSocket ===== */
function connectWS(){
  const proto = location.protocol==="https:" ? "wss" : "ws";
  ws = new WebSocket(proto + "://" + location.host + "/ws");

  ws.onopen = () => {
    addLog("[WS] connected");
    reconnectDelay = 1000;
  };

  ws.onclose = () => {
    addLog("[WS] disconnected","log-err");
    setTimeout(connectWS, reconnectDelay);
    reconnectDelay = Math.min(reconnectDelay*2, 10000);
  };

  ws.onmessage = e => {
    const m = JSON.parse(e.data);

    if (m.type === "init_clients") {
      m.data.forEach(id => markOnline(id));
    }

    if (m.type === "client_online") {
      if (!onlineClients.has(m.data)) {
        markOnline(m.data);
        addLog("[+] " + m.data, "log-ok");
      }
    }

    if (m.type === "client_offline") {
      if (onlineClients.has(m.data)) {
        markOffline(m.data);
        addLog("[-] " + m.data, "log-err");
      }
    }

    if (m.type === "task_result") {
      lastSeenMap.set(m.data.device_id, now());
      addLog(
        "["+m.data.device_id+"] " + (m.data.output || m.data.error),
        m.data.error ? "log-err" : "log-ok"
      );
    }
  };
}

/* ===== Client UI ===== */
function ensureRow(id) {
  if (clientRows.has(id)) return clientRows.get(id);

  const li = document.createElement("li");
  li.className = "client offline";
  li.id = "c-"+id;

  li.innerHTML = `
    <div class="client-header">
      <input type="checkbox">
      <span class="id">${id}</span>
      <span class="status"></span>
    </div>
    <div class="lastseen"></div>
  `;

  li.querySelector("input").onclick = e => {
    e.stopPropagation();
    if (e.target.checked) selected.add(id);
    else selected.delete(id);
  };

  clientsUL.appendChild(li);
  clientRows.set(id, li);
  return li;
}

function markOnline(id) {
  const row = ensureRow(id);
  row.classList.remove("offline");
  row.classList.add("online");
  row.querySelector(".status").textContent = "● online";
  row.querySelector(".status").style.color = "var(--green)";
  onlineClients.add(id);
  lastSeenMap.set(id, now());
}

function markOffline(id) {
  const row = ensureRow(id);
  row.classList.remove("online");
  row.classList.add("offline");
  row.querySelector(".status").textContent = "● offline";
  row.querySelector(".status").style.color = "var(--red)";
  onlineClients.delete(id);
}

/* ===== Update last_seen ===== */
setInterval(() => {
  for (const [id, ts] of lastSeenMap.entries()) {
    const row = clientRows.get(id);
    if (!row) continue;
    row.querySelector(".lastseen").textContent =
      "last seen: " + formatAgo(ts);
  }
}, 1000);

/* ===== Command ===== */
function execCmd(){
  const c = cmdInput.value.trim();
  if (!c) return;

  fetch("/api/exec", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      command: c,
      target: selected.size ? [...selected] : "ALL"
    })
  });

  addLog("> " + c);
  cmdInput.value="";
}

cmdInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") execCmd();
});
</script>

</body>
</html>
