<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>Command Center</title>

<style>
:root{
  --bg:#0b1020; --panel:#11162a; --border:#24304f;
  --text:#e6e8ef; --muted:#8b93b8; --blue:#4f7cff;
  --green:#22c55e; --red:#ef4444;
}
*{box-sizing:border-box;font-family:ui-monospace,Menlo,monospace;}
body{margin:0;background:var(--bg);color:var(--text);height:100vh;}

/* LOGIN */
#login{height:100vh;display:flex;align-items:center;justify-content:center;}
.login-box{width:360px;padding:28px;background:var(--panel);border:1px solid var(--border);border-radius:10px;}
.login-box h1{text-align:center;margin:0 0 12px;}
.login-box input{width:100%;margin-top:12px;padding:10px;background:transparent;color:var(--text);border:1px solid var(--border);border-radius:6px;}
.login-box button{width:100%;margin-top:16px;padding:10px;background:var(--blue);border:none;border-radius:6px;color:#fff;cursor:pointer;}

/* APP */
#app{display:none;height:100vh;}
#layout{display:grid;grid-template-columns:320px 1fr;height:100%;}
#sidebar{background:var(--panel);border-right:1px solid var(--border);padding:12px;display:flex;flex-direction:column;}
#sidebar h3{margin:6px 0 8px;font-size:13px;color:var(--muted);}

#client-tools{display:flex;gap:6px;margin-bottom:8px;}
#client-tools button{flex:1;padding:6px;font-size:12px;background:#1b2345;border:1px solid var(--border);color:var(--text);cursor:pointer;border-radius:6px;}

#clients{list-style:none;padding:0;margin:0;overflow-y:auto;flex:1;}
.client{border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;}
.client-header{display:flex;align-items:center;gap:6px;}
.client-header span.id{flex:1;font-size:13px;word-break:break-all;}
.client.online{border-color:#1e3a8a;}
.client.offline{opacity:0.6;}
.client .status{font-size:11px;}
.client .lastseen{font-size:11px;color:var(--muted);margin-top:4px;}

/* MAIN */
#main{display:flex;flex-direction:column;height:100%;}
#topbar{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border);align-items:center;}
#cmd{flex:1;padding:10px;background:transparent;border:1px solid var(--border);color:var(--text);border-radius:6px;}
#run{padding:10px 18px;background:var(--blue);border:none;color:#fff;cursor:pointer;border-radius:6px;}
#historyBtn{background:#1b2345;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;cursor:pointer;}
#historyPanel{position:absolute;left:340px;top:64px;width:560px;max-height:360px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:8px;overflow:auto;display:none;z-index:50;}
#historyPanel input{width:100%;padding:8px;margin-bottom:8px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text);}

.history-entry{padding:8px;border-radius:6px;margin-bottom:6px;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;gap:8px;cursor:pointer;}
.history-entry:hover{background:#0e1730;}
.history-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.history-meta{color:var(--muted);font-size:12px;min-width:90px;text-align:right;}
.history-actions{display:flex;gap:6px;margin-left:8px;}
.small-btn{background:#1b2345;border:1px solid var(--border);color:var(--text);padding:6px;border-radius:6px;cursor:pointer;font-size:12px;}

/* LOG */
#log{flex:1;padding:12px;overflow-y:auto;white-space:pre-wrap;font-size:13px;}
.log-ok{color:var(--green);} .log-err{color:var(--red);} .log-info{color:var(--muted);}

/* FOOTER */
#footer{padding:6px 12px;font-size:12px;color:var(--muted);border-top:1px solid var(--border);position:relative;}
#targets{font-weight:600;color:var(--blue);}

/* responsive */
@media (max-width:1000px){
  #historyPanel{left:20px;top:72px;width:calc(100% - 40px);}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <h1>Command Center</h1>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div id="layout">

    <div id="sidebar">
      <h3>Clients</h3>
      <div id="client-tools">
        <button onclick="selectAll(true)">All</button>
        <button onclick="selectAll(false)">None</button>
      </div>
      <ul id="clients"></ul>
    </div>

    <div id="main">
      <div id="topbar">
        <input id="cmd" placeholder="command (↑↓ history)">
        <button id="run">Run</button>
        <button id="historyBtn">History</button>
      </div>

      <div id="historyPanel" aria-hidden="true">
        <input id="historySearch" placeholder="Search history...">
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button id="clearHistory" class="small-btn">Clear history</button>
          <button id="exportHistory" class="small-btn">Export</button>
          <button id="importHistory" class="small-btn">Import</button>
        </div>
        <div id="historyList"></div>
      </div>

      <div id="log"></div>

      <div id="footer">
        Targets: <span id="targets">ALL</span>
      </div>
    </div>

  </div>
</div>

<!-- file input for import (hidden) -->
<input id="importFile" type="file" accept="application/json" style="display:none">

<script>
/* ===== DOM ===== */
const loginBox = document.getElementById('login');
const appBox = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const userInput = document.getElementById('user');
const passInput = document.getElementById('pass');

const cmdInput = document.getElementById('cmd');
const runBtn = document.getElementById('run');
const historyBtn = document.getElementById('historyBtn');
const historyPanel = document.getElementById('historyPanel');
const historySearch = document.getElementById('historySearch');
const historyList = document.getElementById('historyList');
const clearHistoryBtn = document.getElementById('clearHistory');
const exportHistoryBtn = document.getElementById('exportHistory');
const importHistoryBtn = document.getElementById('importHistory');
const importFile = document.getElementById('importFile');

const logBox = document.getElementById('log');
const clientsUL = document.getElementById('clients');
const targetsSpan = document.getElementById('targets');

let ws;
let reconnectDelay = 1000;
const selected = new Set();
const onlineClients = new Set();
const lastSeenMap = new Map();
const clientRows = new Map();

/* ===== History storage model =====
store key: cmdHistory
value: JSON.stringify([{cmd:"...", ts: 168...}, ...])
Most recent first (index 0)
Max entries: 200
*/
const HISTORY_KEY = 'cmdHistory';
const HISTORY_MAX = 200;
let history = loadHistory(); // array of {cmd,ts}
let hIndex = history.length; // for arrow nav: points after last element

/* ===== Utils ===== */
function now(){ return Date.now(); }
function fmtAgo(ts){
  const s = Math.floor((now()-ts)/1000);
  if(s<60) return s+'s';
  if(s<3600) return Math.floor(s/60)+'m';
  if(s<86400) return Math.floor(s/3600)+'h';
  return Math.floor(s/86400)+'d';
}
function addLog(msg, cls='log-info'){
  const d = document.createElement('div'); d.className=cls; d.textContent=msg;
  logBox.appendChild(d); logBox.scrollTop = logBox.scrollHeight;
}

/* ===== History functions ===== */
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr.slice(0, HISTORY_MAX);
  }catch(e){ return []; }
}

function saveHistory(){
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0,HISTORY_MAX)));
}

function pushHistory(cmd){
  if(!cmd) return;
  // remove existing duplicate
  history = history.filter(h=>h.cmd !== cmd);
  // add to front
  history.unshift({cmd:cmd, ts: now()});
  if(history.length>HISTORY_MAX) history.length = HISTORY_MAX;
  saveHistory();
  hIndex = history.length;
  renderHistoryList();
}

// remove all history
function clearHistory(){
  history = []; saveHistory(); renderHistoryList();
}

// export as JSON
function exportHistory(){
  const blob = new Blob([JSON.stringify(history, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'cmd_history.json'; a.click();
  URL.revokeObjectURL(url);
}

// import (simple)
function importHistoryFile(file){
  const r = new FileReader();
  r.onload = () => {
    try{
      const arr = JSON.parse(r.result);
      if(Array.isArray(arr)){
        // merge and dedupe, keep newest first by ts
        const map = new Map();
        for(const it of [...arr, ...history]){
          if(it && it.cmd) map.set(it.cmd, it);
        }
        const merged = Array.from(map.values()).sort((a,b)=>b.ts - a.ts).slice(0, HISTORY_MAX);
        history = merged; saveHistory(); renderHistoryList();
        alert('Import OK, total ' + history.length);
      } else alert('Invalid file');
    }catch(e){ alert('Import failed'); }
  };
  r.readAsText(file);
}

/* ===== History UI rendering ===== */
function renderHistoryList(filter){
  historyList.innerHTML = '';
  const f = (filter||'').toLowerCase();
  for(const it of history){
    if(f && !it.cmd.toLowerCase().includes(f)) continue;
    const el = document.createElement('div');
    el.className = 'history-entry';
    el.title = it.cmd;
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;width:100%">
        <div class="history-text">${escapeHtml(it.cmd)}</div>
        <div class="history-actions">
          <button class="small-btn" data-action="run">Run</button>
          <button class="small-btn" data-action="fill">Fill</button>
        </div>
      </div>
      <div class="history-meta">${fmtAgo(it.ts)}</div>
    `;
    // actions
    el.querySelector('[data-action="run"]').onclick = e => {
      e.stopPropagation();
      runFromHistory(it.cmd);
    };
    el.querySelector('[data-action="fill"]').onclick = e => {
      e.stopPropagation();
      cmdInput.value = it.cmd;
      cmdInput.focus();
      closeHistoryPanel();
    };
    // click on whole entry fills
    el.onclick = ()=>{ cmdInput.value = it.cmd; cmdInput.focus(); closeHistoryPanel(); };
    historyList.appendChild(el);
  }
  if(historyList.childElementCount === 0){
    historyList.innerHTML = '<div style="color:var(--muted);padding:8px">no history</div>';
  }
}

function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ===== History-driven commands ===== */
function runFromHistory(cmd){
  cmdInput.value = cmd;
  execCmd();
}

/* ===== Interaction: show/hide history panel ===== */
function openHistoryPanel(){
  renderHistoryList(historySearch.value);
  historyPanel.style.display = 'block';
  historyPanel.setAttribute('aria-hidden','false');
  historySearch.focus();
}
function closeHistoryPanel(){
  historyPanel.style.display = 'none';
  historyPanel.setAttribute('aria-hidden','true');
}

/* ===== Event listeners for history UI ===== */
historyBtn.addEventListener('click', ()=> {
  if(historyPanel.style.display === 'block') closeHistoryPanel();
  else openHistoryPanel();
});
historySearch.addEventListener('input', ()=> renderHistoryList(historySearch.value));
clearHistoryBtn.addEventListener('click', ()=> {
  if(confirm('Clear all history?')) clearHistory();
});
exportHistoryBtn.addEventListener('click', exportHistory);
importHistoryBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', e => {
  if(e.target.files && e.target.files[0]) importHistoryFile(e.target.files[0]);
  importFile.value = '';
});

/* ===== Keyboard nav for cmd input (history) ===== */
cmdInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    execCmd();
    e.preventDefault();
    return;
  }
  if(e.key === 'ArrowUp'){
    if(history.length === 0) return;
    if(hIndex > 0) hIndex--;
    cmdInput.value = history[hIndex] ? history[hIndex].cmd : '';
    e.preventDefault();
  } else if(e.key === 'ArrowDown'){
    if(history.length === 0) return;
    if(hIndex < history.length - 1) hIndex++;
    else { hIndex = history.length; cmdInput.value = ''; }
    cmdInput.value = history[hIndex] ? history[hIndex].cmd : '';
    e.preventDefault();
  } else {
    // any edit resets navigation position to end
    hIndex = history.length;
  }
});

/* ===== Command execution ===== */
function execCmd(){
  const c = cmdInput.value.trim();
  if(!c) return;
  // send
  fetch('/api/exec', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      command: c,
      target: selected.size ? [...selected] : 'ALL'
    })
  });
  addLog('> ' + c, 'log-info');
  pushHistory(c);
  cmdInput.value = '';
}

/* ===== Websocket and client UI (kept compatible) ===== */
loginBtn.addEventListener('click', doLogin);
runBtn.addEventListener('click', execCmd);

function doLogin(){
  fetch('/api/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ user: userInput.value, pass: passInput.value })
  }).then(r=>{
    if(r.ok){
      loginBox.style.display='none';
      appBox.style.display='block';
      connectWS();
    } else {
      alert('login failed');
    }
  });
}

function connectWS(){
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(proto + '://' + location.host + '/ws');

  ws.onopen = ()=>{ addLog('[WS] connected'); reconnectDelay = 1000; };
  ws.onclose = ()=>{ addLog('[WS] disconnected', 'log-err'); setTimeout(connectWS, reconnectDelay); reconnectDelay = Math.min(reconnectDelay*2, 10000); };
  ws.onmessage = e => {
    const m = JSON.parse(e.data);
    if(m.type === 'init_clients'){
      m.data.forEach(id => markOnline(id));
    }
    if(m.type === 'client_online'){
      if(!onlineClients.has(m.data)){ markOnline(m.data); addLog('[+] ' + m.data, 'log-ok'); }
    }
    if(m.type === 'client_offline'){
      if(onlineClients.has(m.data)){ markOffline(m.data); addLog('[-] ' + m.data, 'log-err'); }
    }
    if(m.type === 'task_result'){
      lastSeenMap.set(m.data.device_id, now());
      addLog('['+m.data.device_id+'] ' + (m.data.output || m.data.error), m.data.error ? 'log-err' : 'log-ok');
    }
  };
}

/* ===== Client UI helpers (kept similar to earlier) ===== */
function ensureRow(id){
  if(clientRows.has(id)) return clientRows.get(id);
  const li = document.createElement('li');
  li.className = 'client offline';
  li.id = 'c-' + id;
  li.innerHTML = `
    <div class="client-header">
      <input type="checkbox">
      <span class="id">${id}</span>
      <span class="status">● offline</span>
    </div>
    <div class="lastseen">last seen: -</div>
  `;
  li.querySelector('input').onclick = e => { e.stopPropagation(); toggleClientSelection(id, e.target.checked); };
  clientsUL.appendChild(li);
  clientRows.set(id, li);
  return li;
}
function markOnline(id){
  const row = ensureRow(id);
  row.classList.remove('offline'); row.classList.add('online');
  row.querySelector('.status').textContent = '● online'; row.querySelector('.status').style.color = 'var(--green)';
  onlineClients.add(id); lastSeenMap.set(id, now()); updateRowLastSeen(id);
}
function markOffline(id){
  const row = ensureRow(id);
  row.classList.remove('online'); row.classList.add('offline');
  row.querySelector('.status').textContent = '● offline'; row.querySelector('.status').style.color = 'var(--red)';
  onlineClients.delete(id);
}
function toggleClientSelection(id, checked){
  if(checked) selected.add(id); else selected.delete(id);
  updateTargets();
}
function selectAll(on){
  selected.clear();
  clientRows.forEach((row,id)=>{ const cb=row.querySelector('input'); cb.checked = on; if(on) selected.add(id); });
  updateTargets();
}
function updateTargets(){ targetsSpan.textContent = selected.size ? [...selected].join(',') : 'ALL'; }

/* ===== last_seen updater every second ===== */
setInterval(()=>{
  for(const [id, ts] of lastSeenMap.entries()){
    const row = clientRows.get(id);
    if(!row) continue;
    row.querySelector('.lastseen').textContent = 'last seen: ' + fmtAgo(ts);
  }
}, 1000);

function updateRowLastSeen(id){
  const row = clientRows.get(id);
  if(!row) return;
  const ts = lastSeenMap.get(id) || now();
  row.querySelector('.lastseen').textContent = 'last seen: ' + fmtAgo(ts);
}

/* ===== initial render of history list ===== */
renderHistoryList();

/* ===== click outside history to close ===== */
document.addEventListener('click', e => {
  if(!historyPanel.contains(e.target) && e.target !== historyBtn) closeHistoryPanel();
});
</script>
</body>
</html>
